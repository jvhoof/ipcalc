# Generated by generate-ipcalc skill
# Base CIDR: {{ base_cidr }}
# Networks: {{ num_vnets }}
# Subnets per network: {{ subnets_per_vnet }}

terraform {
  required_version = ">= 1.0"
  required_providers {
    azurerm = {
      source  = "hashicorp/azurerm"
      version = "~> 3.0"
    }
  }
}

provider "azurerm" {
  features {}
}

# Variables
variable "resource_group_name" {
  description = "Name of the resource group"
  type        = string
  default     = "network-rg"
}

variable "location" {
  description = "Azure region for resources"
  type        = string
  default     = "eastus"
}

variable "prefix" {
  description = "Prefix for resource naming"
  type        = string
  default     = "network"
}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default = {
    Environment = "dev"
    ManagedBy   = "terraform"
  }
}

# Resource Group
resource "azurerm_resource_group" "main" {
  name     = var.resource_group_name
  location = var.location
  tags     = var.tags
}

{% for network in networks %}
# ============================================================================
# Virtual Network: {{ network.name }}
# CIDR: {{ network.cidr }}
# Total IPs: {{ network.total_ips | int | format_number }}
# Usable IPs: {{ network.usable_ips | int | format_number }}
# ============================================================================

resource "azurerm_virtual_network" "{{ network.name | replace('-', '_') }}" {
  name                = "$${var.prefix}-{{ network.name }}"
  location            = azurerm_resource_group.main.location
  resource_group_name = azurerm_resource_group.main.name
  address_space       = ["{{ network.cidr }}"]

  tags = var.tags
}

{% for subnet in network.subnets %}
# Subnet: {{ subnet.name }} ({{ subnet.cidr }})
# Usable IPs: {{ subnet.usable_ips | int | format_number }}
resource "azurerm_subnet" "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}" {
  name                 = "$${var.prefix}-{{ network.name }}-{{ subnet.name }}"
  resource_group_name  = azurerm_resource_group.main.name
  virtual_network_name = azurerm_virtual_network.{{ network.name | replace('-', '_') }}.name
  address_prefixes     = ["{{ subnet.cidr }}"]
}

{% endfor %}
{% endfor %}

# ============================================================================
# Outputs
# ============================================================================

output "resource_group_name" {
  description = "Name of the resource group"
  value       = azurerm_resource_group.main.name
}

output "resource_group_location" {
  description = "Location of the resource group"
  value       = azurerm_resource_group.main.location
}

{% for network in networks %}
output "{{ network.name | replace('-', '_') }}_id" {
  description = "ID of {{ network.name }}"
  value       = azurerm_virtual_network.{{ network.name | replace('-', '_') }}.id
}

output "{{ network.name | replace('-', '_') }}_name" {
  description = "Name of {{ network.name }}"
  value       = azurerm_virtual_network.{{ network.name | replace('-', '_') }}.name
}

output "{{ network.name | replace('-', '_') }}_address_space" {
  description = "Address space of {{ network.name }}"
  value       = azurerm_virtual_network.{{ network.name | replace('-', '_') }}.address_space
}

{% for subnet in network.subnets %}
output "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}_id" {
  description = "ID of {{ network.name }}/{{ subnet.name }}"
  value       = azurerm_subnet.{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}.id
}

{% endfor %}
{% endfor %}

# ============================================================================
# IP Allocation Table
# ============================================================================

/*
Base Network: {{ base_cidr }}
Total IPs: {{ base_network_info.total_ips | int | format_number }}
Usable IPs: {{ base_network_info.usable_ips | int | format_number }}

Network Allocation:
{% for network in networks %}
{{ loop.index }}. {{ network.name }}
   CIDR: {{ network.cidr }}
   Range: {{ network.network_address }} - {{ network.broadcast_address }}
   Usable: {{ network.first_usable }} - {{ network.last_usable }}
   Total IPs: {{ network.total_ips | int | format_number }}

   Subnets:
{% for subnet in network.subnets %}
   {{ loop.index }}. {{ subnet.name }}: {{ subnet.cidr }}
      Range: {{ subnet.first_usable }} - {{ subnet.last_usable }}
      Usable IPs: {{ subnet.usable_ips | int | format_number }}
{% endfor %}

{% endfor %}
*/
