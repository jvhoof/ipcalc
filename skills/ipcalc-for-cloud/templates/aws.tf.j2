# Generated by generate-ipcalc skill
# Base CIDR: {{ base_cidr }}
# Networks: {{ num_vnets }}
# Subnets per network: {{ subnets_per_vnet }}

terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
  }
}

provider "aws" {
  region = var.aws_region
}

# Variables
variable "aws_region" {
  description = "AWS region for resources"
  type        = string
  default     = "us-east-1"
}

variable "prefix" {
  description = "Prefix for resource naming"
  type        = string
  default     = "network"
}

variable "enable_dns_hostnames" {
  description = "Enable DNS hostnames in VPCs"
  type        = bool
  default     = true
}

variable "enable_dns_support" {
  description = "Enable DNS support in VPCs"
  type        = bool
  default     = true
}

variable "tags" {
  description = "Tags to apply to resources"
  type        = map(string)
  default = {
    Environment = "dev"
    ManagedBy   = "terraform"
  }
}

{% for network in networks %}
# ============================================================================
# VPC: {{ network.name }}
# CIDR: {{ network.cidr }}
# Total IPs: {{ network.total_ips | int | format_number }}
# Usable IPs: {{ network.usable_ips | int | format_number }}
# ============================================================================

resource "aws_vpc" "{{ network.name | replace('-', '_') }}" {
  cidr_block           = "{{ network.cidr }}"
  enable_dns_hostnames = var.enable_dns_hostnames
  enable_dns_support   = var.enable_dns_support

  tags = merge(
    var.tags,
    {
      Name = "$${var.prefix}-{{ network.name }}"
    }
  )
}

# Internet Gateway for {{ network.name }}
resource "aws_internet_gateway" "{{ network.name | replace('-', '_') }}" {
  vpc_id = aws_vpc.{{ network.name | replace('-', '_') }}.id

  tags = merge(
    var.tags,
    {
      Name = "$${var.prefix}-{{ network.name }}-igw"
    }
  )
}

# Route Table for {{ network.name }}
resource "aws_route_table" "{{ network.name | replace('-', '_') }}" {
  vpc_id = aws_vpc.{{ network.name | replace('-', '_') }}.id

  route {
    cidr_block = "0.0.0.0/0"
    gateway_id = aws_internet_gateway.{{ network.name | replace('-', '_') }}.id
  }

  tags = merge(
    var.tags,
    {
      Name = "$${var.prefix}-{{ network.name }}-rt"
    }
  )
}

{% for subnet in network.subnets %}
# Subnet: {{ subnet.name }} ({{ subnet.cidr }})
# Usable IPs: {{ subnet.usable_ips | int | format_number }}
resource "aws_subnet" "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}" {
  vpc_id            = aws_vpc.{{ network.name | replace('-', '_') }}.id
  cidr_block        = "{{ subnet.cidr }}"
  availability_zone = data.aws_availability_zones.available.names[{{ loop.index0 }} % length(data.aws_availability_zones.available.names)]

  map_public_ip_on_launch = true

  tags = merge(
    var.tags,
    {
      Name = "$${var.prefix}-{{ network.name }}-{{ subnet.name }}"
    }
  )
}

# Route Table Association for {{ subnet.name }}
resource "aws_route_table_association" "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}" {
  subnet_id      = aws_subnet.{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}.id
  route_table_id = aws_route_table.{{ network.name | replace('-', '_') }}.id
}

{% endfor %}
{% endfor %}

# ============================================================================
# Data Sources
# ============================================================================

data "aws_availability_zones" "available" {
  state = "available"
}

# ============================================================================
# Outputs
# ============================================================================

output "aws_region" {
  description = "AWS region"
  value       = var.aws_region
}

output "availability_zones" {
  description = "Available availability zones"
  value       = data.aws_availability_zones.available.names
}

{% for network in networks %}
output "{{ network.name | replace('-', '_') }}_id" {
  description = "ID of {{ network.name }}"
  value       = aws_vpc.{{ network.name | replace('-', '_') }}.id
}

output "{{ network.name | replace('-', '_') }}_cidr" {
  description = "CIDR block of {{ network.name }}"
  value       = aws_vpc.{{ network.name | replace('-', '_') }}.cidr_block
}

output "{{ network.name | replace('-', '_') }}_igw_id" {
  description = "Internet Gateway ID for {{ network.name }}"
  value       = aws_internet_gateway.{{ network.name | replace('-', '_') }}.id
}

{% for subnet in network.subnets %}
output "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}_id" {
  description = "ID of {{ network.name }}/{{ subnet.name }}"
  value       = aws_subnet.{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}.id
}

output "{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}_az" {
  description = "Availability zone of {{ network.name }}/{{ subnet.name }}"
  value       = aws_subnet.{{ network.name | replace('-', '_') }}_{{ subnet.name | replace('-', '_') }}.availability_zone
}

{% endfor %}
{% endfor %}

# ============================================================================
# IP Allocation Table
# ============================================================================

/*
Base Network: {{ base_cidr }}
Total IPs: {{ base_network_info.total_ips | int | format_number }}
Usable IPs: {{ base_network_info.usable_ips | int | format_number }}

Network Allocation:
{% for network in networks %}
{{ loop.index }}. {{ network.name }}
   CIDR: {{ network.cidr }}
   Range: {{ network.network_address }} - {{ network.broadcast_address }}
   Usable: {{ network.first_usable }} - {{ network.last_usable }}
   Total IPs: {{ network.total_ips | int | format_number }}

   Subnets:
{% for subnet in network.subnets %}
   {{ loop.index }}. {{ subnet.name }}: {{ subnet.cidr }}
      Range: {{ subnet.first_usable }} - {{ subnet.last_usable }}
      Usable IPs: {{ subnet.usable_ips | int | format_number }}
{% endfor %}

{% endfor %}
*/
