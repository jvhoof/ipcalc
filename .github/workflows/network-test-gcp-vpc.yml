name: "[Network] GCP VPC Deployment Test"

on:
  workflow_dispatch:  # Allow manual trigger with parameters
    inputs:
      prefix:
        description: 'Resource prefix for naming'
        required: false
        default: 'ipcalc-qa'
      region:
        description: 'GCP region'
        required: false
        default: 'eu-central1'
      vpc_cidr:
        description: 'VPC CIDR block'
        required: false
        default: '172.16.1.0/24'
      subnet_count:
        description: 'Number of subnets to create'
        required: false
        default: '4'
  push:
    branches:
      - main  # Trigger on push to main branch
    paths-ignore:
      - '.github/workflows/**'
  pull_request:
    paths:
      - 'src/templates/gcp/**'
      - '.github/workflows/gcp-vpc-test.yml'

env:
  # Workflow parameters - workflow_dispatch inputs take precedence over env vars
  RESOURCE_PREFIX: ${{ github.event.inputs.prefix || vars.GCP_RESOURCE_PREFIX || 'ipcalc-test' }}
  GCP_REGION: ${{ github.event.inputs.region || vars.GCP_REGION || 'eu-central1' }}
  VPC_CIDR: ${{ github.event.inputs.vpc_cidr || vars.GCP_VPC_CIDR || '172.16.1.0/24' }}
  SUBNET_COUNT: ${{ github.event.inputs.subnet_count || vars.GCP_SUBNET_COUNT || '4' }}

jobs:
  deploy-with-terraform:
    name: Deploy and Test with Terraform
    runs-on: ubuntu-latest

    # Add these permissions for Workload Identity Federation
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Generate Unique Identifier
        id: unique-id
        run: |
          UNIQUE_ID=$(echo $RANDOM | md5sum | head -c 4)
          echo "id=$UNIQUE_ID" >> $GITHUB_OUTPUT
          echo "Generated unique ID: $UNIQUE_ID"
          VPC_NAME="${{ env.RESOURCE_PREFIX }}-$UNIQUE_ID-vpc"
          JOB_PREFIX="${{ env.RESOURCE_PREFIX }}-$UNIQUE_ID"
          echo "VPC_NAME=$VPC_NAME" >> $GITHUB_ENV
          echo "JOB_PREFIX=$JOB_PREFIX" >> $GITHUB_ENV

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Generate Terraform Configuration using ipcalc CLI
        id: generate-terraform
        run: |
          echo "Generating Terraform configuration using ipcalc CLI..."
          echo "Parameters:"
          echo "  Provider: gcp"
          echo "  CIDR: ${{ env.VPC_CIDR }}"
          echo "  Subnets: ${{ env.SUBNET_COUNT }}"
          echo "  Region: ${{ env.GCP_REGION }}"
          echo "  Prefix: ${{ env.JOB_PREFIX }}"

          # Generate Terraform configuration using ipcalc CLI
          npm run cli -- \
            --provider gcp \
            --cidr ${{ env.VPC_CIDR }} \
            --subnets ${{ env.SUBNET_COUNT }} \
            --output terraform \
            --file /tmp/test-terraform.tf

          echo "Terraform configuration generated successfully"
          echo "Configuration contents:"
          cat /tmp/test-terraform.tf

      - name: Initialize Terraform
        working-directory: /tmp
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Validate Terraform Configuration
        working-directory: /tmp
        run: |
          echo "Validating Terraform configuration..."
          terraform validate

      - name: Plan Terraform Deployment
        working-directory: /tmp
        run: |
          echo "Planning Terraform deployment..."
          terraform plan \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "vpc_name=${{ env.VPC_NAME }}" \
            -out=tfplan

      - name: Apply Terraform Deployment
        id: deploy
        working-directory: /tmp
        run: |
          echo "Applying Terraform deployment..."
          terraform apply -auto-approve tfplan

          # Extract outputs
          VPC_NAME=$(terraform output -raw vpc_name)
          VPC_ID=$(terraform output -raw vpc_id)
          VPC_SELF_LINK=$(terraform output -raw vpc_self_link)

          echo "vpc_name=$VPC_NAME" >> $GITHUB_OUTPUT
          echo "vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
          echo "vpc_self_link=$VPC_SELF_LINK" >> $GITHUB_OUTPUT

          echo "VPC_SELF_LINK=$VPC_SELF_LINK" >> $GITHUB_ENV

          echo "âœ… Deployment completed successfully"
          echo "VPC Name: $VPC_NAME"
          echo "VPC ID: $VPC_ID"

      - name: Validate Deployment
        id: validate
        run: |
          echo "ðŸ” Validating deployment..."

          # Check if VPC exists
          echo "Checking if VPC ${{ env.VPC_NAME }} exists..."
          VPC_EXISTS=$(gcloud compute networks describe "${{ env.VPC_NAME }}" \
            --format="value(name)" 2>/dev/null || echo "")

          if [ -z "$VPC_EXISTS" ]; then
            echo "âŒ VPC not found!"
            exit 1
          fi
          echo "âœ… VPC exists: $VPC_EXISTS"

          # Validate VPC configuration
          echo "Validating VPC configuration..."
          VPC_MODE=$(gcloud compute networks describe "${{ env.VPC_NAME }}" \
            --format="value(autoCreateSubnetworks)")

          if [ "$VPC_MODE" != "False" ]; then
            echo "âŒ VPC should be in custom subnet mode!"
            exit 1
          fi
          echo "âœ… VPC is in custom subnet mode"

          # List and validate subnets
          echo "Listing subnets..."
          SUBNET_LIST=$(gcloud compute networks subnets list \
            --network="${{ env.VPC_NAME }}" \
            --format="table(name,region,ipCidrRange)")

          echo "$SUBNET_LIST"

          SUBNET_COUNT=$(gcloud compute networks subnets list \
            --network="${{ env.VPC_NAME }}" \
            --format="value(name)" | wc -l)

          echo "âœ… Found $SUBNET_COUNT subnet(s)"

          if [ "$SUBNET_COUNT" -lt 1 ]; then
            echo "âŒ No subnets found!"
            exit 1
          fi

          # Display detailed subnet information
          echo "Subnet details:"
          gcloud compute networks subnets list \
            --network="${{ env.VPC_NAME }}" \
            --format="table(name,region,ipCidrRange,privateIpGoogleAccess)"

          echo "âœ… All subnets are available"
          echo "âœ… Validation completed successfully!"

      - name: Generate Test Report
        if: always()
        run: |
          echo "## ðŸ“Š GCP VPC Deployment Test Report" > /tmp/test-report.md
          echo "" >> /tmp/test-report.md
          echo "**Deployment Method:** Terraform" >> /tmp/test-report.md
          echo "**Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> /tmp/test-report.md
          echo "**VPC Name:** ${{ env.VPC_NAME }}" >> /tmp/test-report.md
          echo "**Project ID:** ${{ secrets.GCP_PROJECT_ID }}" >> /tmp/test-report.md
          echo "**Region:** ${{ env.GCP_REGION }}" >> /tmp/test-report.md
          echo "**VPC CIDR:** ${{ env.VPC_CIDR }}" >> /tmp/test-report.md
          echo "" >> /tmp/test-report.md

          if [ "${{ steps.validate.outcome }}" == "success" ]; then
            echo "### âœ… Validation Status: PASSED" >> /tmp/test-report.md
          else
            echo "### âŒ Validation Status: FAILED" >> /tmp/test-report.md
          fi

          echo "" >> /tmp/test-report.md
          echo "### Subnets Created:" >> /tmp/test-report.md
          echo '```' >> /tmp/test-report.md
          if [ -n "${{ env.VPC_NAME }}" ]; then
            gcloud compute networks subnets list \
              --network="${{ env.VPC_NAME }}" \
              --format="table(name,region,ipCidrRange)" >> /tmp/test-report.md 2>&1 || echo "Failed to list subnets" >> /tmp/test-report.md
          else
            echo "VPC Name not available" >> /tmp/test-report.md
          fi
          echo '```' >> /tmp/test-report.md

          cat /tmp/test-report.md
          cat /tmp/test-report.md >> $GITHUB_STEP_SUMMARY

      - name: Cleanup Resources
        if: always()
        working-directory: /tmp
        run: |
          echo "ðŸ§¹ Cleaning up resources..."

          # Try to destroy using Terraform first
          echo "Attempting to destroy resources using Terraform..."
          if terraform destroy -auto-approve \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "vpc_name=${{ env.VPC_NAME }}"; then
            echo "âœ… Terraform destroy completed successfully"
          else
            echo "âš ï¸ Terraform destroy failed"
            echo "Attempting manual cleanup of VPC resources..."

            if [ -n "${{ env.VPC_NAME }}" ]; then
              # Delete firewall rules first (dependencies)
              echo "Deleting firewall rules..."
              FIREWALL_RULES=$(gcloud compute firewall-rules list \
                --filter="network:${{ env.VPC_NAME }}" \
                --format="value(name)")

              for fw_rule in $FIREWALL_RULES; do
                echo "Deleting firewall rule: $fw_rule"
                gcloud compute firewall-rules delete "$fw_rule" --quiet || true
              done

              # Delete subnets
              echo "Deleting subnets..."
              SUBNETS=$(gcloud compute networks subnets list \
                --network="${{ env.VPC_NAME }}" \
                --format="value(name,region)")

              echo "$SUBNETS" | while read -r subnet region; do
                if [ -n "$subnet" ] && [ -n "$region" ]; then
                  echo "Deleting subnet: $subnet in region $region"
                  gcloud compute networks subnets delete "$subnet" \
                    --region="$region" --quiet || true
                fi
              done

              # Delete VPC
              echo "Deleting VPC: ${{ env.VPC_NAME }}"
              gcloud compute networks delete "${{ env.VPC_NAME }}" --quiet || true

              echo "âœ… Manual cleanup completed"
            else
              echo "âš ï¸ VPC Name not available, skipping manual cleanup"
            fi
          fi

          echo "âœ… Cleanup completed"

  # ========================================
  # VPC Peering Tests (Hub-Spoke Topology)
  # ========================================

  deploy-peering-with-gcloud:
    name: Deploy and Test VPC Peering with gcloud CLI
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Generate Unique Identifier
        id: unique-id
        run: |
          UNIQUE_ID=$(echo $RANDOM | md5sum | head -c 4)
          echo "id=$UNIQUE_ID" >> $GITHUB_OUTPUT
          echo "Generated unique ID: $UNIQUE_ID"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Generate gcloud CLI Script with VPC Peering
        id: generate-script
        run: |
          echo "Generating gcloud CLI script with VPC peering using ipcalc CLI..."
          echo "Parameters:"
          echo "  Provider: gcp"
          echo "  Hub CIDR: 10.0.0.0/16"
          echo "  Hub Subnets: 2"
          echo "  Spoke CIDRs: 10.1.0.0/16,10.2.0.0/16,10.3.0.0/16"
          echo "  Spoke Subnets: 2,2,2"

          # Generate gcloud CLI script with VPC peering
          npm run cli -- \
            --provider gcp \
            --cidr 10.0.0.0/16 \
            --subnets 2 \
            --spoke-cidrs "10.1.0.0/16,10.2.0.0/16,10.3.0.0/16" \
            --spoke-subnets "2,2,2" \
            --output gcloud \
            --file /tmp/deploy-vpc-peering-generated.sh

          # Set unique names for this job
          JOB_PREFIX="${{ env.RESOURCE_PREFIX }}-${{ steps.unique-id.outputs.id }}"
          VPC_NAME="${JOB_PREFIX}-vpc"

          echo "JOB_PREFIX=$JOB_PREFIX" >> $GITHUB_ENV
          echo "VPC_NAME=$VPC_NAME" >> $GITHUB_ENV

          # Customize the script
          sed -i "s/PROJECT_ID=\"your-project-id\"/PROJECT_ID=\"${{ secrets.GCP_PROJECT_ID }}\"/" /tmp/deploy-vpc-peering-generated.sh
          sed -i "s/VPC_NAME=\"myproject-vpc\"/VPC_NAME=\"${VPC_NAME}\"/" /tmp/deploy-vpc-peering-generated.sh
          chmod +x /tmp/deploy-vpc-peering-generated.sh

          echo "Script contents:"
          cat /tmp/deploy-vpc-peering-generated.sh

      - name: Execute gcloud CLI Deployment
        run: /tmp/deploy-vpc-peering-generated.sh

      - name: Validate VPC Peering
        run: |
          echo "ðŸ” Validating VPC peering connections..."

          # First, list all peerings for debugging
          echo "All peerings on hub VPC:"
          gcloud compute networks peerings list \
            --network="${{ env.VPC_NAME }}"

          for spoke_num in 1 2 3; do
            PEERING_NAME="hub-to-spoke${spoke_num}"

            # Get all peerings and grep for the specific one
            PEERING_INFO=$(gcloud compute networks peerings list \
              --network="${{ env.VPC_NAME }}" \
              --flatten="peerings[]" \
              --format="csv(peerings.name,name,peerings.state)" 2>/dev/null | grep "^${PEERING_NAME}," || echo "")

            if [ -z "$PEERING_INFO" ]; then
              echo "âŒ Peering $PEERING_NAME not found!"
              exit 1
            fi

            PEERING_STATUS=$(echo "$PEERING_INFO" | cut -d',' -f3)

            if [ "$PEERING_STATUS" != "ACTIVE" ]; then
              echo "âŒ Peering $PEERING_NAME not active! Status: $PEERING_STATUS"
              exit 1
            fi
            echo "âœ… Peering $PEERING_NAME is active"
          done

          for spoke_num in 1 2 3; do
            PEERING_NAME="spoke${spoke_num}-to-hub"

            # Get all peerings and grep for the specific one
            PEERING_INFO=$(gcloud compute networks peerings list \
              --flatten="peerings[]" \
              --format="csv(peerings.name,name,peerings.state)" 2>/dev/null | grep "^${PEERING_NAME}," || echo "")

            if [ -z "$PEERING_INFO" ]; then
              echo "âŒ Peering $PEERING_NAME not found!"
              exit 1
            fi

            PEERING_STATUS=$(echo "$PEERING_INFO" | cut -d',' -f3)

            if [ "$PEERING_STATUS" != "ACTIVE" ]; then
              echo "âŒ Peering $PEERING_NAME not active! Status: $PEERING_STATUS"
              exit 1
            fi
            echo "âœ… Peering $PEERING_NAME is active"
          done

          echo "âœ… All VPC peerings are active!"

      - name: Cleanup Resources
        if: always()
        run: |
          echo "ðŸ§¹ Cleaning up VPC peering resources..."

          # Delete spoke VPCs (this will also delete peerings)
          for spoke_num in 1 2 3; do
            SPOKE_VPC="${{ env.VPC_NAME }}-spoke${spoke_num}"
            echo "Deleting spoke VPC: $SPOKE_VPC"

            # Delete firewall rules first
            FIREWALL_RULES=$(gcloud compute firewall-rules list \
              --filter="network:$SPOKE_VPC" \
              --format="value(name)" 2>/dev/null || echo "")

            for fw_rule in $FIREWALL_RULES; do
              echo "Deleting firewall rule: $fw_rule"
              gcloud compute firewall-rules delete "$fw_rule" --quiet || true
            done

            # Delete subnets
            SUBNETS=$(gcloud compute networks subnets list \
              --network="$SPOKE_VPC" \
              --format="value(name,region)" 2>/dev/null || echo "")

            echo "$SUBNETS" | while read -r subnet region; do
              if [ -n "$subnet" ] && [ -n "$region" ]; then
                echo "Deleting subnet: $subnet in region $region"
                gcloud compute networks subnets delete "$subnet" \
                  --region="$region" --quiet || true
              fi
            done

            # Delete spoke VPC
            gcloud compute networks delete "$SPOKE_VPC" --quiet || true
          done

          # Delete hub VPC
          echo "Deleting hub VPC: ${{ env.VPC_NAME }}"

          # Delete firewall rules
          FIREWALL_RULES=$(gcloud compute firewall-rules list \
            --filter="network:${{ env.VPC_NAME }}" \
            --format="value(name)" 2>/dev/null || echo "")

          for fw_rule in $FIREWALL_RULES; do
            echo "Deleting firewall rule: $fw_rule"
            gcloud compute firewall-rules delete "$fw_rule" --quiet || true
          done

          # Delete subnets
          SUBNETS=$(gcloud compute networks subnets list \
            --network="${{ env.VPC_NAME }}" \
            --format="value(name,region)" 2>/dev/null || echo "")

          echo "$SUBNETS" | while read -r subnet region; do
            if [ -n "$subnet" ] && [ -n "$region" ]; then
              echo "Deleting subnet: $subnet in region $region"
              gcloud compute networks subnets delete "$subnet" \
                --region="$region" --quiet || true
            fi
          done

          # Delete hub VPC
          gcloud compute networks delete "${{ env.VPC_NAME }}" --quiet || true

          echo "âœ… Cleanup completed"

  deploy-peering-with-terraform:
    name: Deploy and Test VPC Peering with Terraform
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      - name: Generate Unique Identifier
        id: unique-id
        run: |
          UNIQUE_ID=$(echo $RANDOM | md5sum | head -c 4)
          echo "id=$UNIQUE_ID" >> $GITHUB_OUTPUT
          echo "Generated unique ID: $UNIQUE_ID"

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Generate Terraform Configuration with VPC Peering
        id: generate-terraform
        run: |
          echo "Generating Terraform configuration with VPC peering using ipcalc CLI..."
          echo "Parameters:"
          echo "  Provider: gcp"
          echo "  Hub CIDR: 10.0.0.0/16"
          echo "  Hub Subnets: 2"
          echo "  Spoke CIDRs: 10.1.0.0/16,10.2.0.0/16,10.3.0.0/16"
          echo "  Spoke Subnets: 2,2,2"

          # Set unique names for this job
          JOB_PREFIX="${{ env.RESOURCE_PREFIX }}-${{ steps.unique-id.outputs.id }}"
          VPC_NAME="${JOB_PREFIX}-vpc"

          echo "JOB_PREFIX=$JOB_PREFIX" >> $GITHUB_ENV
          echo "VPC_NAME=$VPC_NAME" >> $GITHUB_ENV

          # Generate Terraform configuration with VPC peering
          npm run cli -- \
            --provider gcp \
            --cidr 10.0.0.0/16 \
            --subnets 2 \
            --spoke-cidrs "10.1.0.0/16,10.2.0.0/16,10.3.0.0/16" \
            --spoke-subnets "2,2,2" \
            --output terraform \
            --file /tmp/test-terraform-peering.tf

          echo "Terraform configuration generated successfully"
          echo "Configuration contents:"
          cat /tmp/test-terraform-peering.tf

      - name: Initialize Terraform
        working-directory: /tmp
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Validate Terraform Configuration
        working-directory: /tmp
        run: |
          echo "Validating Terraform configuration..."
          terraform validate

      - name: Plan Terraform Deployment
        working-directory: /tmp
        run: |
          echo "Planning Terraform deployment..."
          terraform plan \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "vpc_name=${{ env.VPC_NAME }}" \
            -out=tfplan

      - name: Apply Terraform Deployment
        id: deploy
        working-directory: /tmp
        run: |
          echo "Applying Terraform deployment..."
          terraform apply -auto-approve tfplan

          echo "âœ… Deployment completed successfully"

      - name: Validate VPC Peering
        run: |
          echo "ðŸ” Validating VPC peering connections..."

          # First, list all peerings for debugging
          echo "All peerings on hub VPC:"
          gcloud compute networks peerings list \
            --network="${{ env.VPC_NAME }}"

          for spoke_num in 1 2 3; do
            PEERING_NAME="hub-to-spoke${spoke_num}"

            # Get all peerings and grep for the specific one
            PEERING_INFO=$(gcloud compute networks peerings list \
              --network="${{ env.VPC_NAME }}" \
              --flatten="peerings[]" \
              --format="csv(peerings.name,name,peerings.state)" 2>/dev/null | grep "^${PEERING_NAME}," || echo "")

            if [ -z "$PEERING_INFO" ]; then
              echo "âŒ Peering $PEERING_NAME not found!"
              exit 1
            fi

            PEERING_STATUS=$(echo "$PEERING_INFO" | cut -d',' -f3)

            if [ "$PEERING_STATUS" != "ACTIVE" ]; then
              echo "âŒ Peering $PEERING_NAME not active! Status: $PEERING_STATUS"
              exit 1
            fi
            echo "âœ… Peering $PEERING_NAME is active"
          done

          for spoke_num in 1 2 3; do
            PEERING_NAME="spoke${spoke_num}-to-hub"

            # Get all peerings and grep for the specific one
            PEERING_INFO=$(gcloud compute networks peerings list \
              --flatten="peerings[]" \
              --format="csv(peerings.name,name,peerings.state)" 2>/dev/null | grep "^${PEERING_NAME}," || echo "")

            if [ -z "$PEERING_INFO" ]; then
              echo "âŒ Peering $PEERING_NAME not found!"
              exit 1
            fi

            PEERING_STATUS=$(echo "$PEERING_INFO" | cut -d',' -f3)

            if [ "$PEERING_STATUS" != "ACTIVE" ]; then
              echo "âŒ Peering $PEERING_NAME not active! Status: $PEERING_STATUS"
              exit 1
            fi
            echo "âœ… Peering $PEERING_NAME is active"
          done

          echo "âœ… All VPC peerings are active!"

      - name: Cleanup Resources
        if: always()
        working-directory: /tmp
        run: |
          echo "ðŸ§¹ Cleaning up resources..."

          # Try to destroy using Terraform first
          echo "Attempting to destroy resources using Terraform..."
          if terraform destroy -auto-approve \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "vpc_name=${{ env.VPC_NAME }}"; then
            echo "âœ… Terraform destroy completed successfully"
          else
            echo "âš ï¸ Terraform destroy failed, attempting manual cleanup..."

            # Delete spoke VPCs
            for spoke_num in 1 2 3; do
              SPOKE_VPC="${{ env.VPC_NAME }}-spoke${spoke_num}"
              echo "Deleting spoke VPC: $SPOKE_VPC"

              # Delete firewall rules
              FIREWALL_RULES=$(gcloud compute firewall-rules list \
                --filter="network:$SPOKE_VPC" \
                --format="value(name)" 2>/dev/null || echo "")

              for fw_rule in $FIREWALL_RULES; do
                echo "Deleting firewall rule: $fw_rule"
                gcloud compute firewall-rules delete "$fw_rule" --quiet || true
              done

              # Delete subnets
              SUBNETS=$(gcloud compute networks subnets list \
                --network="$SPOKE_VPC" \
                --format="value(name,region)" 2>/dev/null || echo "")

              echo "$SUBNETS" | while read -r subnet region; do
                if [ -n "$subnet" ] && [ -n "$region" ]; then
                  echo "Deleting subnet: $subnet in region $region"
                  gcloud compute networks subnets delete "$subnet" \
                    --region="$region" --quiet || true
                fi
              done

              # Delete spoke VPC
              gcloud compute networks delete "$SPOKE_VPC" --quiet || true
            done

            # Delete hub VPC
            if [ -n "${{ env.VPC_NAME }}" ]; then
              # Delete firewall rules
              FIREWALL_RULES=$(gcloud compute firewall-rules list \
                --filter="network:${{ env.VPC_NAME }}" \
                --format="value(name)" 2>/dev/null || echo "")

              for fw_rule in $FIREWALL_RULES; do
                echo "Deleting firewall rule: $fw_rule"
                gcloud compute firewall-rules delete "$fw_rule" --quiet || true
              done

              # Delete subnets
              SUBNETS=$(gcloud compute networks subnets list \
                --network="${{ env.VPC_NAME }}" \
                --format="value(name,region)" 2>/dev/null || echo "")

              echo "$SUBNETS" | while read -r subnet region; do
                if [ -n "$subnet" ] && [ -n "$region" ]; then
                  echo "Deleting subnet: $subnet in region $region"
                  gcloud compute networks subnets delete "$subnet" \
                    --region="$region" --quiet || true
                fi
              done

              # Delete hub VPC
              gcloud compute networks delete "${{ env.VPC_NAME }}" --quiet || true
            fi

            echo "âœ… Manual cleanup completed"
          fi

          echo "âœ… Cleanup completed"
