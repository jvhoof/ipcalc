name: "[Network] GCP CLI Test"

on:
  workflow_dispatch:  # Allow manual trigger with parameters
    inputs:
      prefix:
        description: 'Resource prefix for naming'
        required: false
        default: 'ipcalc-qa'
      region:
        description: 'GCP region'
        required: false
        default: 'eu-central1'
      vpc_cidr:
        description: 'VPC CIDR block'
        required: false
        default: '172.16.1.0/24'
      subnet_count:
        description: 'Number of subnets to create'
        required: false
        default: '4'
  push:
    branches:
      - beta  # Trigger on push to beta branch
  pull_request:
    paths:
      - 'src/templates/gcp/**'
      - '.github/workflows/gcp-vpc-test.yml'

env:
  # Workflow parameters - workflow_dispatch inputs take precedence over env vars
  RESOURCE_PREFIX: ${{ github.event.inputs.prefix || vars.GCP_RESOURCE_PREFIX || 'ipcalc-test' }}
  GCP_REGION: ${{ github.event.inputs.region || vars.GCP_REGION || 'eu-central1' }}
  VPC_CIDR: ${{ github.event.inputs.vpc_cidr || vars.GCP_VPC_CIDR || '172.16.1.0/24' }}
  SUBNET_COUNT: ${{ github.event.inputs.subnet_count || vars.GCP_SUBNET_COUNT || '4' }}

jobs:
  deploy-with-terraform:
    name: Ready set test
    runs-on: ubuntu-latest

    # Add these permissions for Workload Identity Federation
    permissions:
      id-token: 'write'
      contents: 'read'

    steps:
      - name: "Generate Unique Identifier"
        id: unique-id
        run: |
          UNIQUE_ID=$(echo $RANDOM | md5sum | head -c 4)
          echo "id=$UNIQUE_ID" >> $GITHUB_OUTPUT
          echo "Generated unique ID: $UNIQUE_ID"
          VPC_NAME="${{ env.RESOURCE_PREFIX }}-$UNIQUE_ID-vpc"
          JOB_PREFIX="${{ env.RESOURCE_PREFIX }}-$UNIQUE_ID"
          echo "VPC_NAME=$VPC_NAME" >> $GITHUB_ENV
          echo "JOB_PREFIX=$JOB_PREFIX" >> $GITHUB_ENV

      - name: Ready set test
        id: test-set
        run: |
          echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
          echo "org=$GITHUB_ORG"
          echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
          set

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install Dependencies
        run: npm ci
        
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v3
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          project_id: 'infra-lodge-268907'
 
      - name: Ready set test 2
        id: test-set2
        run: |
          echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="
          OIDC_JWT=$(curl -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" "$ACTIONS_ID_TOKEN_REQUEST_URL" | jq -r .value)
          echo "OIDC_JWT=$OIDC_JWT"
          cat $OIDC_JWT | base64 
          echo "ACTIONS_ID_TOKEN_REQUEST_TOKEN=$ACTIONS_ID_TOKEN_REQUEST_TOKEN"
          echo "ACTIONS_ID_TOKEN_REQUEST_URL=$ACTIONS_ID_TOKEN_REQUEST_URL"
          echo "=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-="

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: "1.9.0"

      - name: Generate Terraform Configuration using ipcalc CLI
        id: generate-terraform
        run: |
          echo "Generating Terraform configuration using ipcalc CLI..."
          echo "Parameters:"
          echo "  Provider: gcp"
          echo "  CIDR: ${{ env.VPC_CIDR }}"
          echo "  Subnets: ${{ env.SUBNET_COUNT }}"
          echo "  Region: ${{ env.GCP_REGION }}"
          echo "  Prefix: ${{ env.JOB_PREFIX }}"

          # Generate Terraform configuration using ipcalc CLI
          npm run cli -- \
            --provider gcp \
            --cidr ${{ env.VPC_CIDR }} \
            --subnets ${{ env.SUBNET_COUNT }} \
            --output terraform \
            --file /tmp/test-terraform.tf

          echo "Terraform configuration generated successfully"
          echo "Configuration contents:"
          cat /tmp/test-terraform.tf

      - name: Initialize Terraform
        working-directory: /tmp
        run: |
          echo "Initializing Terraform..."
          terraform init

      - name: Validate Terraform Configuration
        working-directory: /tmp
        run: |
          echo "Validating Terraform configuration..."
          terraform validate

      - name: Plan Terraform Deployment
        working-directory: /tmp
        run: |
          echo "Planning Terraform deployment..."
          terraform plan \
            -var "project_id=${{ secrets.GCP_PROJECT_ID }}" \
            -var "vpc_name=${{ env.VPC_NAME }}" \
            -out=tfplan

      - name: Apply Terraform Deployment
        id: deploy
        working-directory: /tmp
        run: |
          echo "Applying Terraform deployment..."
          terraform apply -auto-approve tfplan

          # Extract outputs
          VPC_NAME=$(terraform output -raw vpc_name)
          VPC_ID=$(terraform output -raw vpc_id)
          VPC_SELF_LINK=$(terraform output -raw vpc_self_link)

          echo "vpc_name=$VPC_NAME" >> $GITHUB_OUTPUT
          echo "vpc_id=$VPC_ID" >> $GITHUB_OUTPUT
          echo "vpc_self_link=$VPC_SELF_LINK" >> $GITHUB_OUTPUT

          echo "VPC_SELF_LINK=$VPC_SELF_LINK" >> $GITHUB_ENV

          echo "âœ… Deployment completed successfully"
          echo "VPC Name: $VPC_NAME"
          echo "VPC ID: $VPC_ID"